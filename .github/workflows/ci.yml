name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.github/dependabot.yml'
  pull_request:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.github/dependabot.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install ruff
        run: pip install ruff

      - name: Lint all packages
        run: ruff check packages/

      - name: Format check
        run: ruff format --check packages/

  test-core:
    name: Test Core (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-core-${{ matrix.python-version }}-${{ hashFiles('packages/core/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-core-${{ matrix.python-version }}-

      - name: Install dependencies
        run: pip install -e "packages/core/[dev,api]"

      - name: Test with coverage
        run: pytest packages/core/tests/ -v --tb=short --cov=animus --cov-report=term-missing
        env:
          ANIMUS_SKIP_INTEGRATION_TESTS: "1"

  test-quorum:
    name: Test Quorum
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-quorum-${{ hashFiles('packages/quorum/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-quorum-

      - name: Install dependencies
        run: pip install -e "packages/quorum/[dev]"

      - name: Test with coverage
        run: PYTHONPATH=packages/quorum/python pytest packages/quorum/tests/ -v --tb=short

  test-forge:
    name: Test Forge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-forge-${{ hashFiles('packages/forge/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-forge-

      - name: Install dependencies
        run: pip install -e "packages/forge/[dev]"

      - name: Test with coverage
        working-directory: packages/forge
        run: pytest tests/ -v --tb=short --cov=animus_forge --cov-report=term-missing

  test-bootstrap:
    name: Test Bootstrap (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-bootstrap-${{ matrix.python-version }}-${{ hashFiles('packages/bootstrap/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-bootstrap-${{ matrix.python-version }}-

      - name: Install dependencies
        run: pip install -e "packages/bootstrap/[dev]"

      - name: Test with coverage
        run: pytest packages/bootstrap/tests/ -v --tb=short --cov=animus_bootstrap --cov-report=term-missing
        env:
          PYTHONPATH: packages/bootstrap/src

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test-core, test-quorum, test-forge, test-bootstrap, security]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-bench-${{ hashFiles('packages/*/pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-bench-

      - name: Install all packages
        run: |
          pip install -e "packages/quorum/[dev]"
          pip install -e "packages/forge/[dev]"
          pip install -e "packages/core/[dev,api]"

      - name: Run Core benchmarks
        run: >
          pytest packages/core/tests/test_benchmarks.py
          --benchmark-only --benchmark-disable-gc --benchmark-warmup=on
          --benchmark-json=.benchmarks/core.json -q

      - name: Run Forge benchmarks
        working-directory: packages/forge
        run: >
          pytest tests/test_benchmarks.py
          --benchmark-only --benchmark-disable-gc --benchmark-warmup=on
          --benchmark-json=../../.benchmarks/forge.json -q

      - name: Run Quorum benchmarks
        run: >
          PYTHONPATH=packages/quorum/python pytest packages/quorum/tests/test_benchmarks.py
          --benchmark-only --benchmark-disable-gc --benchmark-warmup=on
          --benchmark-json=.benchmarks/quorum.json -q
        env:
          PYTHONPATH: packages/quorum/python

      - name: Merge benchmark results
        run: |
          python3 -c "
          import json, glob
          merged = {'benchmarks': []}
          for f in sorted(glob.glob('.benchmarks/*.json')):
              data = json.load(open(f))
              pkg = f.split('/')[-1].replace('.json', '')
              for b in data.get('benchmarks', []):
                  b['group'] = pkg
                  merged['benchmarks'].append(b)
          merged['machine_info'] = data.get('machine_info', {})
          merged['commit_info'] = data.get('commit_info', {})
          merged['datetime'] = data.get('datetime', '')
          json.dump(merged, open('.benchmarks/merged.json', 'w'), indent=2)
          print(f'Merged {len(merged[\"benchmarks\"])} benchmarks')
          "

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: pytest
          output-file-path: .benchmarks/merged.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '150%'
          fail-on-alert: false
          comment-on-alert: true
          benchmark-data-dir-path: dev/bench

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: .benchmarks/
          retention-days: 90
